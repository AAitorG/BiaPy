

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>util &mdash; EM Image Segmentation  documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> EM Image Segmentation
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">How to run</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../how_to_run.html">Step 0: Prepare environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how_to_run.html#step-1-choose-a-template">Step 1: Choose a template</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how_to_run.html#step-2-data-structure">Step 2: Data structure</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how_to_run.html#step-3-run-the-code">Step 3: Run the code</a></li>
</ul>
<p class="caption"><span class="caption-text">2D Data</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../data_2d_manipulation.html">Data manipulation 2D</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2d_generator_keras.html">2D generator (Keras)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2d_generator.html">2D generator (Custom)</a></li>
</ul>
<p class="caption"><span class="caption-text">3D Data</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../data_3d_manipulation.html">Data manipulation 3D</a></li>
<li class="toctree-l1"><a class="reference internal" href="../3d_generator.html">3D generator</a></li>
</ul>
<p class="caption"><span class="caption-text">Networks</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../networks_unet2d.html">2D U-Net</a></li>
<li class="toctree-l1"><a class="reference internal" href="../networks_unet3d.html">3D U-Net</a></li>
<li class="toctree-l1"><a class="reference internal" href="../networks_nnunet.html">nnU-Net</a></li>
<li class="toctree-l1"><a class="reference internal" href="../networks_fcn.html">FCN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../networks_fc_densetnet103.html">Tiramisu (FC-DenseNet103)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../networks_multiresunet.html">MultiResUNet</a></li>
<li class="toctree-l1"><a class="reference internal" href="../networks_mnet.html">MNet</a></li>
</ul>
<p class="caption"><span class="caption-text">Utilities</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../metrics.html">Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../util.html">Util</a></li>
<li class="toctree-l1"><a class="reference internal" href="../post_processing.html">Post processing</a></li>
</ul>
<p class="caption"><span class="caption-text">Reproduced methods</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../casser.html">Casser et al.</a></li>
<li class="toctree-l1"><a class="reference internal" href="../xiao.html">Xiao et al.</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cheng.html">Cheng et al.</a></li>
<li class="toctree-l1"><a class="reference internal" href="../oztel.html">Oztel et al.</a></li>
</ul>
<p class="caption"><span class="caption-text">Auxiliary code</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../grad_cam.html">Grad-CAM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../adabound.html">Adabound</a></li>
<li class="toctree-l1"><a class="reference internal" href="../callbacks.html">Callbacks</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">EM Image Segmentation</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">Module code</a> &raquo;</li>
        
      <li>util</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for util</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="c1">#import mkl</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">skimage.io</span> <span class="kn">import</span> <span class="n">imread</span>                                                   
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">ImageEnhance</span><span class="p">,</span> <span class="n">Image</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">from</span> <span class="nn">skimage</span> <span class="kn">import</span> <span class="n">measure</span>
<span class="kn">from</span> <span class="nn">skimage.transform</span> <span class="kn">import</span> <span class="n">resize</span>
<span class="kn">import</span> <span class="nn">scipy.ndimage</span>
<span class="kn">from</span> <span class="nn">skimage.segmentation</span> <span class="kn">import</span> <span class="n">clear_border</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span> 
<span class="kn">from</span> <span class="nn">metrics</span> <span class="kn">import</span> <span class="n">jaccard_index</span><span class="p">,</span> <span class="n">jaccard_index_numpy</span><span class="p">,</span> <span class="n">voc_calculation</span><span class="p">,</span> \
                    <span class="n">DET_calculation</span>


<div class="viewcode-block" id="limit_threads"><a class="viewcode-back" href="../util.html#util.limit_threads">[docs]</a><span class="k">def</span> <span class="nf">limit_threads</span><span class="p">(</span><span class="n">threads_number</span><span class="o">=</span><span class="s1">&#39;1&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Limits the number of threads for a python process.</span>
<span class="sd">       </span>
<span class="sd">       Parameters</span>
<span class="sd">       ---------- </span>
<span class="sd">       threads_number : int, optional</span>
<span class="sd">           Number of threads.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Python process limited to </span><span class="si">{}</span><span class="s2"> thread&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">threads_number</span><span class="p">))</span>

    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;MKL_NUM_THREADS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;OPENBLAS_NUM_THREADS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;MKL_DYNAMIC&quot;</span><span class="p">]</span><span class="o">=</span><span class="s2">&quot;FALSE&quot;</span><span class="p">;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;NUMEXPR_NUM_THREADS&quot;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;1&#39;</span><span class="p">;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;VECLIB_MAXIMUM_THREADS&quot;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;1&#39;</span><span class="p">;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;OMP_NUM_THREADS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span><span class="p">;</span></div>
    <span class="c1">#mkl.set_num_threads(1)</span>


<div class="viewcode-block" id="set_seed"><a class="viewcode-back" href="../util.html#util.set_seed">[docs]</a><span class="k">def</span> <span class="nf">set_seed</span><span class="p">(</span><span class="n">seedValue</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">determinism</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sets the seed on multiple python modules to obtain results as </span>
<span class="sd">       reproducible as possible.</span>

<span class="sd">       Parameters</span>
<span class="sd">       ----------</span>
<span class="sd">       seedValue : int, optional</span>
<span class="sd">           Seed value.</span>
<span class="sd">        </span>
<span class="sd">       determinism : bool, optional</span>
<span class="sd">           To force determism. </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">random</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="n">seedValue</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">seedValue</span><span class="p">)</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="n">seedValue</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;PYTHONHASHSEED&quot;</span><span class="p">]</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">seedValue</span><span class="p">);</span>
    <span class="k">if</span> <span class="n">determinism</span><span class="p">:</span>    
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;TF_DETERMINISTIC_OPS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span></div>
    

<div class="viewcode-block" id="TimeHistory"><a class="viewcode-back" href="../util.html#util.TimeHistory">[docs]</a><span class="k">class</span> <span class="nc">TimeHistory</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">Callback</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class to record each epoch time.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="TimeHistory.on_train_begin"><a class="viewcode-back" href="../util.html#util.TimeHistory.on_train_begin">[docs]</a>    <span class="k">def</span> <span class="nf">on_train_begin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logs</span><span class="o">=</span><span class="p">{}):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">times</span> <span class="o">=</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="TimeHistory.on_epoch_begin"><a class="viewcode-back" href="../util.html#util.TimeHistory.on_epoch_begin">[docs]</a>    <span class="k">def</span> <span class="nf">on_epoch_begin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">logs</span><span class="o">=</span><span class="p">{}):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epoch_time_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span></div>

<div class="viewcode-block" id="TimeHistory.on_epoch_end"><a class="viewcode-back" href="../util.html#util.TimeHistory.on_epoch_end">[docs]</a>    <span class="k">def</span> <span class="nf">on_epoch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">logs</span><span class="o">=</span><span class="p">{}):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_time_start</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="create_plots"><a class="viewcode-back" href="../util.html#util.create_plots">[docs]</a><span class="k">def</span> <span class="nf">create_plots</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">chartOutDir</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;jaccard_index&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create loss and main metric plots with the given results.</span>

<span class="sd">       Parameters</span>
<span class="sd">       ----------</span>
<span class="sd">       results : Keras History object</span>
<span class="sd">           Record of training loss values and metrics values at successive </span>
<span class="sd">           epochs. History object is returned by Keras `fit() </span>
<span class="sd">           &lt;https://keras.io/api/models/model_training_apis/#fit-method&gt;`_ method.</span>

<span class="sd">       job_id : str</span>
<span class="sd">           Jod identifier.</span>

<span class="sd">       chartOutDir : str    </span>
<span class="sd">           Path where the charts will be stored into.</span>
<span class="sd">            </span>
<span class="sd">       metric : str, optional</span>
<span class="sd">           Metric used.</span>

<span class="sd">       Examples</span>
<span class="sd">       --------</span>
<span class="sd">       </span>
<span class="sd">       +-----------------------------------------+-----------------------------------------+</span>
<span class="sd">       | .. figure:: img/chart_loss.png          | .. figure:: img/chart_jaccard_index.png |</span>
<span class="sd">       |   :width: 80%                           |   :width: 80%                           |</span>
<span class="sd">       |   :align: center                        |   :align: center                        |</span>
<span class="sd">       |                                         |                                         |</span>
<span class="sd">       |   Loss values on each epoch             |   Jaccard index values on each epoch    |</span>
<span class="sd">       +-----------------------------------------+-----------------------------------------+</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">chartOutDir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># For matplotlib errors in display</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;QT_QPA_PLATFORM&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;offscreen&#39;</span>

    <span class="c1"># Loss</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Model JOBID=&#39;</span> <span class="o">+</span> <span class="n">job_id</span> <span class="o">+</span> <span class="s1">&#39; loss&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Value&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Epoch&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;Train loss&#39;</span><span class="p">,</span> <span class="s1">&#39;Val. loss&#39;</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">chartOutDir</span><span class="p">,</span> <span class="n">job_id</span> <span class="o">+</span> <span class="s1">&#39;_loss.png&#39;</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>

    <span class="c1"># Jaccard index</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="n">metric</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_&#39;</span> <span class="o">+</span> <span class="n">metric</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Model JOBID=&#39;</span> <span class="o">+</span> <span class="n">job_id</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">metric</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Value&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Epoch&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;Train metric&#39;</span><span class="p">,</span> <span class="s1">&#39;Val. metric&#39;</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">chartOutDir</span><span class="p">,</span> <span class="n">job_id</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">metric</span> <span class="o">+</span><span class="s1">&#39;.png&#39;</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span></div>


<div class="viewcode-block" id="store_history"><a class="viewcode-back" href="../util.html#util.store_history">[docs]</a><span class="k">def</span> <span class="nf">store_history</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="n">time_callback</span><span class="p">,</span> <span class="n">log_dir</span><span class="p">,</span> <span class="n">job_file</span><span class="p">,</span> 
                  <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;jaccard_index&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Stores the results obtained as csv to manipulate them later </span>
<span class="sd">       and labeled in another file as historic results.</span>

<span class="sd">       Parameters</span>
<span class="sd">       ----------</span>
<span class="sd">       results : Keras History object</span>
<span class="sd">           Record of training loss values and metrics values at successive </span>
<span class="sd">           epochs.</span>

<span class="sd">       score : Dictionary</span>
<span class="sd">           Contains all metrics values extracted from training and inference. </span>

<span class="sd">       time_callback : ``util.TimeHistory``</span>
<span class="sd">           Time structure with the time of each epoch.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Create folders and construct file names</span>
    <span class="n">csv_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">log_dir</span><span class="p">,</span> <span class="s1">&#39;formatted&#39;</span><span class="p">,</span> <span class="n">job_file</span><span class="p">)</span>          
    <span class="n">history_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">log_dir</span><span class="p">,</span> <span class="s1">&#39;history_of_values&#39;</span><span class="p">,</span> <span class="n">job_file</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">log_dir</span><span class="p">,</span> <span class="s1">&#39;formatted&#39;</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">log_dir</span><span class="p">,</span> <span class="s1">&#39;history_of_values&#39;</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># Store the results as csv</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">csv_file</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_file</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">)</span>

    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">]))</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">]))</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;loss_per_crop&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="n">metric</span><span class="p">]))</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_&#39;</span><span class="o">+</span><span class="n">metric</span><span class="p">]))</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;jac_per_crop&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;jac_per_image&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;jac_50ov&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;jac_full&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;smo_jac_per_image&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;zfil_jac_per_image&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;smo_zfil_jac_per_image&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;smo_jac_full&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;zfil_jac_full&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;spu_jac_full&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;wa_jac_full&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;spu_wa_zfil_jac_full&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;voc_per_image&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;voc_50ov&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;voc_full&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;smo_voc_per_image&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;zfil_voc_per_image&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;smo_zfil_voc_per_image&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;smo_voc_full&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;zfil_voc_full&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;spu_voc_full&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;wa_voc_full&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;spu_wa_zfil_voc_full&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;det_per_image&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;det_50ov&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;det_full&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;smo_det_per_image&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;zfil_det_per_image&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;smo_zfil_det_per_image&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;smo_det_full&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;zfil_det_full&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;spu_det_full&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;wa_det_full&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;spu_wa_zfil_det_full&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">]))</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">time_callback</span><span class="o">.</span><span class="n">times</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">time_callback</span><span class="o">.</span><span class="n">times</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>

    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># Save all the values in case we need them in the future</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">history_file</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">history_file</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;### TRAIN LOSS ### </span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;### VALIDATION LOSS ### </span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;### TEST LOSS ### </span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;loss_per_crop&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;### TRAIN JACCARD INDEX ### </span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="n">metric</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;### VALIDATION JACCARD INDEX ### </span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_&#39;</span><span class="o">+</span><span class="n">metric</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;### TEST JACCARD INDEX (per crop) ### </span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;jac_per_crop&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;### TEST JACCARD INDEX (per image) ### </span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;jac_per_image&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;### TEST JACCARD INDEX (per image with 50</span><span class="si">% o</span><span class="s1">v) ### </span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;jac_50ov&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;### TEST JACCARD INDEX (full) ### </span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;jac_full&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;### TEST JACCARD INDEX SMOOTH (per image) ### </span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;smo_jac_per_image&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;### TEST JACCARD INDEX Z-FILTERING (per image) ### </span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;zfil_jac_per_image&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;### TEST JACCARD INDEX SMOOTH+Z-FILTERING (per image) ### </span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;smo_zfil_jac_per_image&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;### TEST JACCARD INDEX 8-ENSEMBLE (full) ### </span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;smo_jac_full&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;### TEST JACCARD INDEX Z-FILTERING (full) ### </span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;zfil_jac_full&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;### TEST JACCARD INDEX SPURIOUS (full) ### </span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;spu_jac_full&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;### TEST JACCARD INDEX WATERSHED (full) ### </span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;wa_jac_full&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;### TEST JACCARD INDEX SPURIOUS+WATERSHED+Z-FILTERING (full) ### </span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;spu_wa_zfil_jac_full&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;### VOC (per image) ### </span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;voc_per_image&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;### VOC (per image with 50</span><span class="si">% o</span><span class="s1">v) ### </span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;voc_50ov&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;### VOC (full) ### </span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;voc_full&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;### VOC SMOOTH ### </span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;smo_voc_per_image&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;### VOC Z-FILTERING ### </span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;zfil_voc_per_image&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;### VOC SMOOTH+Z-FILTERING ### </span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;smo_zfil_voc_per_image&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;### VOC INDEX 8-ENSEMBLE (full) ### </span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;smo_voc_full&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;### VOC INDEX Z-FILTERING (full) ### </span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;zfil_voc_full&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;### VOC INDEX SPURIOUS (full) ### </span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;spu_voc_full&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;### VOC INDEX WATERSHED (full) ### </span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;wa_voc_full&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;### VOC INDEX SPURIOUS+WATERSHED+Z-FILTERING (full) ### </span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;spu_wa_zfil_voc_full&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;### DET (per image) ### </span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;det_per_image&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;### DET (per image with 50</span><span class="si">% o</span><span class="s1">v) ### </span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;det_50ov&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;### DET SMOOTH ### </span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;smo_det_per_image&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;### DET Z-FILTERING ### </span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;zfil_det_per_image&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;### DET SMOOTH+Z-FILTERING ### </span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;smo_zfil_det_per_image&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;### DET INDEX 8-ENSEMBLE (full) ### </span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;smo_det_full&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;### DET INDEX Z-FILTERING (full) ### </span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;zfil_det_full&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;### DET INDEX SPURIOUS (full) ### </span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;spu_det_full&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;### DET INDEX WATERSHED (full) ### </span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;wa_det_full&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;### DET INDEX SPURIOUS+WATERSHED+Z-FILTERING (full) ### </span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">[</span><span class="s1">&#39;spu_wa_zfil_det_full&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="threshold_plots"><a class="viewcode-back" href="../util.html#util.threshold_plots">[docs]</a><span class="k">def</span> <span class="nf">threshold_plots</span><span class="p">(</span><span class="n">preds_test</span><span class="p">,</span> <span class="n">Y_test</span><span class="p">,</span> <span class="n">det_eval_ge_path</span><span class="p">,</span> <span class="n">det_eval_path</span><span class="p">,</span>
                    <span class="n">det_bin</span><span class="p">,</span> <span class="n">n_dig</span><span class="p">,</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">job_file</span><span class="p">,</span> <span class="n">char_dir</span><span class="p">,</span> <span class="n">r_val</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a plot with the different metric values binarizing the prediction</span>
<span class="sd">       with different thresholds, from 0.1 to 0.9.</span>
<span class="sd">                                                                                </span>
<span class="sd">       Parameters</span>
<span class="sd">       ----------                                                                    </span>
<span class="sd">       preds_test : 4D Numpy array</span>
<span class="sd">           Predictions made by the model. E.g. ``(num_of_images, x, y, channels)``.</span>

<span class="sd">       Y_test : 4D Numpy array</span>
<span class="sd">           Ground truth of the data. E.g. ``(num_of_images, x, y, channels)``.</span>

<span class="sd">       det_eval_ge_path : str</span>
<span class="sd">           Path where the ground truth is stored for the DET calculation.</span>

<span class="sd">       det_eval_path : str</span>
<span class="sd">           Path where the evaluation of the metric will be done.</span>

<span class="sd">       det_bin : str </span>
<span class="sd">           Path to the DET binary.</span>

<span class="sd">       n_dig : int</span>
<span class="sd">           The number of digits used for encoding temporal indices (e.g. ``3``).</span>
<span class="sd">           Used by the DET calculation binary.</span>

<span class="sd">       job_id : str</span>
<span class="sd">           Id of the job.</span>

<span class="sd">       job_file : str</span>
<span class="sd">           Id and run number of the job.</span>

<span class="sd">       char_dir : str</span>
<span class="sd">           Path to store the charts generated.</span>

<span class="sd">       r_val : float, optional</span>
<span class="sd">           Threshold values to return. </span>

<span class="sd">       Returns</span>
<span class="sd">       -------</span>
<span class="sd">       t_jac : float</span>
<span class="sd">           Value of the Jaccard index when the threshold is ``r_val``.</span>

<span class="sd">       t_voc : float</span>
<span class="sd">           Value of VOC when the threshold is ``r_val``.</span>

<span class="sd">       t_det : float</span>
<span class="sd">           Value of DET when the threshold is ``r_val``.</span>

<span class="sd">       Examples</span>
<span class="sd">       -------- </span>
<span class="sd">       ::</span>
<span class="sd">       </span>
<span class="sd">           jac, voc, det = threshold_plots(</span>
<span class="sd">               preds_test, Y_test, det_eval_ge_path, det_eval_path, det_bin, </span>
<span class="sd">               n_dig, args.job_id, &#39;278_3&#39;, char_dir)</span>

<span class="sd">       Will generate 3 charts, one per each metric: IoU, VOC and DET. In the x</span>
<span class="sd">       axis represents the 9 different thresholds applied, that is: ``0.1, 0.2, </span>
<span class="sd">       0.3, ..., 0.9``. The y axis is the value of the metric in each chart. For </span>
<span class="sd">       instance, the Jaccard/IoU chart will look like this:</span>

<span class="sd">       .. image:: img/278_3_threshold_Jaccard.png</span>
<span class="sd">           :width: 60%</span>
<span class="sd">           :align: center</span>

<span class="sd">       In this example, the best value, ``0.868``, is obtained with a threshold </span>
<span class="sd">       of ``0.4``.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">char_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">char_dir</span><span class="p">,</span> <span class="s2">&quot;t_&quot;</span> <span class="o">+</span> <span class="n">job_file</span><span class="p">)</span>

    <span class="n">t_jac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>                                                         
    <span class="n">t_voc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>                                                         
    <span class="n">t_det</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>                                                         
    <span class="n">objects</span> <span class="o">=</span> <span class="p">[]</span>                                                                
    <span class="n">r_val_pos</span> <span class="o">=</span> <span class="mi">0</span>
                                                                                
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">1.0</span><span class="p">,</span><span class="mf">0.1</span><span class="p">)):</span>                              
    
        <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="n">r_val</span><span class="p">:</span>
            <span class="n">r_val_pos</span> <span class="o">=</span> <span class="n">i</span>

        <span class="n">objects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">float</span><span class="p">(</span><span class="n">t</span><span class="p">)))</span>                                                  
                                                                                
        <span class="c1"># Threshold images                                                      </span>
        <span class="n">bin_preds_test</span> <span class="o">=</span> <span class="p">(</span><span class="n">preds_test</span> <span class="o">&gt;</span> <span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>                      
                                                                                
        <span class="c1"># Metrics (Jaccard + VOC + DET)                                             </span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Calculate metrics . . .&quot;</span><span class="p">)</span>                                        
        <span class="n">t_jac</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">jaccard_index_numpy</span><span class="p">(</span><span class="n">Y_test</span><span class="p">,</span> <span class="n">bin_preds_test</span><span class="p">)</span>
        <span class="n">t_voc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">voc_calculation</span><span class="p">(</span><span class="n">Y_test</span><span class="p">,</span> <span class="n">bin_preds_test</span><span class="p">,</span> <span class="n">t_jac</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>         
        <span class="n">t_det</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">DET_calculation</span><span class="p">(</span>
            <span class="n">Y_test</span><span class="p">,</span> <span class="n">bin_preds_test</span><span class="p">,</span> <span class="n">det_eval_ge_path</span><span class="p">,</span> <span class="n">det_eval_path</span><span class="p">,</span> 
            <span class="n">det_bin</span><span class="p">,</span> <span class="n">n_dig</span><span class="p">,</span> <span class="n">job_id</span><span class="p">)</span>       
                                                                                
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;t_jac[</span><span class="si">{}</span><span class="s2">]: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">t_jac</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>                        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;t_voc[</span><span class="si">{}</span><span class="s2">]: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">t_voc</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>                        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;t_det[</span><span class="si">{}</span><span class="s2">]: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">t_det</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

    <span class="c1"># For matplotlib errors in display                                          </span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;QT_QPA_PLATFORM&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;offscreen&#39;</span>                                   
    
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">char_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
  
    <span class="c1"># Plot Jaccard values   </span>
    <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">objects</span><span class="p">,</span> <span class="n">t_jac</span><span class="p">)</span>                                   
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Model JOBID=&#39;</span> <span class="o">+</span> <span class="n">job_file</span> <span class="o">+</span> <span class="s1">&#39; Jaccard&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.08</span><span class="p">)</span>                 
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Value&#39;</span><span class="p">)</span>                                                         
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Threshold&#39;</span><span class="p">)</span>                                                     
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">point</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">objects</span><span class="p">,</span> <span class="n">t_jac</span><span class="p">)):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;</span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">float</span><span class="p">(</span><span class="n">t_jac</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">char_dir</span><span class="p">,</span> <span class="n">job_file</span> <span class="o">+</span> <span class="s1">&#39;_threshold_Jaccard.png&#39;</span><span class="p">))</span>    
    <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>                                                                   
                                                                                
    <span class="c1"># Plot VOC values                                                           </span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">objects</span><span class="p">,</span> <span class="n">t_voc</span><span class="p">)</span>                                                    
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Model JOBID=&#39;</span> <span class="o">+</span> <span class="n">job_file</span> <span class="o">+</span> <span class="s1">&#39; VOC&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.08</span><span class="p">)</span>                   
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Value&#39;</span><span class="p">)</span>                                                         
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Threshold&#39;</span><span class="p">)</span>                                                     
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">point</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">objects</span><span class="p">,</span> <span class="n">t_voc</span><span class="p">)):</span>                              
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;</span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">float</span><span class="p">(</span><span class="n">t_voc</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>                  
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">char_dir</span><span class="p">,</span> <span class="n">job_file</span> <span class="o">+</span> <span class="s1">&#39;_threshold_VOC.png&#39;</span><span class="p">))</span>    
    <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
                                                                                
    <span class="c1"># Plot DET values                                                           </span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">objects</span><span class="p">,</span> <span class="n">t_det</span><span class="p">)</span>                                                    
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Model JOBID=&#39;</span> <span class="o">+</span> <span class="n">job_file</span> <span class="o">+</span> <span class="s1">&#39; DET&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.08</span><span class="p">)</span>                       
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Value&#39;</span><span class="p">)</span>                                                         
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Threshold&#39;</span><span class="p">)</span>                                                     
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">point</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">objects</span><span class="p">,</span> <span class="n">t_det</span><span class="p">)):</span>                              
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;</span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">float</span><span class="p">(</span><span class="n">t_det</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>                  
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">char_dir</span><span class="p">,</span> <span class="n">job_file</span> <span class="o">+</span> <span class="s1">&#39;_threshold_DET.png&#39;</span><span class="p">))</span>        
    <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>

    <span class="k">return</span>  <span class="n">t_jac</span><span class="p">[</span><span class="n">r_val_pos</span><span class="p">],</span> <span class="n">t_voc</span><span class="p">[</span><span class="n">r_val_pos</span><span class="p">],</span> <span class="n">t_det</span><span class="p">[</span><span class="n">r_val_pos</span><span class="p">]</span></div>


<div class="viewcode-block" id="array_to_img"><a class="viewcode-back" href="../util.html#util.array_to_img">[docs]</a><span class="k">def</span> <span class="nf">array_to_img</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">data_format</span><span class="o">=</span><span class="s1">&#39;channels_last&#39;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts a 3D Numpy array to a PIL Image instance.</span>

<span class="sd">       As the Keras array_to_img function in:</span>

<span class="sd">            `keras_preprocessing/image/utils.py &lt;https://github.com/keras-team/keras-preprocessing/blob/28b8c9a57703b60ea7d23a196c59da1edf987ca0/keras_preprocessing/image/utils.py#L230&gt;`_</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">Image</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s1">&#39;Could not import PIL.Image. &#39;</span>
                          <span class="s1">&#39;The use of `array_to_img` requires PIL.&#39;</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Expected image array to have rank 3 (single image). &#39;</span>
                         <span class="s1">&#39;Got array with shape: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">,))</span>

    <span class="k">if</span> <span class="n">data_format</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;channels_first&#39;</span><span class="p">,</span> <span class="s1">&#39;channels_last&#39;</span><span class="p">}:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid data_format: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">data_format</span><span class="p">)</span>

    <span class="c1"># Original Numpy array x has format (height, width, channel)</span>
    <span class="c1"># or (channel, height, width)</span>
    <span class="c1"># but target PIL image has format (width, height, channel)</span>
    <span class="k">if</span> <span class="n">data_format</span> <span class="o">==</span> <span class="s1">&#39;channels_first&#39;</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">scale</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">x_max</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">/=</span> <span class="n">x_max</span>
        <span class="n">x</span> <span class="o">*=</span> <span class="mi">255</span>
    <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="c1"># RGBA</span>
        <span class="k">return</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;uint8&#39;</span><span class="p">),</span> <span class="s1">&#39;RGBA&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="c1"># RGB</span>
        <span class="k">return</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;uint8&#39;</span><span class="p">),</span> <span class="s1">&#39;RGB&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># grayscale</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">:</span>
            <span class="c1"># 32-bit signed integer grayscale image. PIL mode &quot;I&quot;</span>
            <span class="k">return</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int32&#39;</span><span class="p">),</span> <span class="s1">&#39;I&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;uint8&#39;</span><span class="p">),</span> <span class="s1">&#39;L&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unsupported channel number: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],))</span></div>


<div class="viewcode-block" id="img_to_array"><a class="viewcode-back" href="../util.html#util.img_to_array">[docs]</a><span class="k">def</span> <span class="nf">img_to_array</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">data_format</span><span class="o">=</span><span class="s1">&#39;channels_last&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts a PIL Image instance to a Numpy array.</span>

<span class="sd">       It&#39;s a copy of the function `keras_preprocessing/image/utils.py &lt;https://github.com/keras-team/keras-preprocessing/blob/28b8c9a57703b60ea7d23a196c59da1edf987ca0/keras_preprocessing/image/utils.py#L288&gt;`_.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">data_format</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;channels_first&#39;</span><span class="p">,</span> <span class="s1">&#39;channels_last&#39;</span><span class="p">}:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unknown data_format: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">data_format</span><span class="p">)</span>
    <span class="c1"># Numpy array x has format (height, width, channel)</span>
    <span class="c1"># or (channel, height, width)</span>
    <span class="c1"># but original PIL image has format (width, height, channel)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">data_format</span> <span class="o">==</span> <span class="s1">&#39;channels_first&#39;</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">data_format</span> <span class="o">==</span> <span class="s1">&#39;channels_first&#39;</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unsupported image shape: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">,))</span>
    <span class="k">return</span> <span class="n">x</span></div>


<div class="viewcode-block" id="save_img"><a class="viewcode-back" href="../util.html#util.save_img">[docs]</a><span class="k">def</span> <span class="nf">save_img</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mask_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scale_mask</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
             <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">extension</span><span class="o">=</span><span class="s2">&quot;.png&quot;</span><span class="p">,</span> <span class="n">filenames</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Save images in the given directory. </span>

<span class="sd">       Parameters</span>
<span class="sd">       ----------                                                                    </span>
<span class="sd">       X : 4D numpy array, optional</span>
<span class="sd">           Data to save as images. The first dimension must be the number of </span>
<span class="sd">           images. E.g. ``(num_of_images, x, y, channels)``.</span>
<span class="sd">    </span>
<span class="sd">       data_dir : str, optional</span>
<span class="sd">           Path to store X images.</span>

<span class="sd">       Y : 4D numpy array, optional</span>
<span class="sd">           Masks to save as images. The first dimension must be the number of </span>
<span class="sd">           images. E.g. ``(num_of_images, x, y, channels)``.</span>

<span class="sd">       scale_mask : bool, optional</span>
<span class="sd">           To allow mask be multiplied by 255.</span>

<span class="sd">       mask_dir : str, optional</span>
<span class="sd">           Path to store Y images. </span>

<span class="sd">       prefix : str, optional</span>
<span class="sd">           Path to store generated charts.</span>

<span class="sd">       filenames : list, optional</span>
<span class="sd">           Filenames that should be used when saving each image. If any provided</span>
<span class="sd">           each image should be named as: ``prefix + &quot;_x_&quot; + image_number + </span>
<span class="sd">           extension`` when ``X.ndim &lt; 4`` and ``prefix + &quot;_x_&quot; + image_number +</span>
<span class="sd">           &quot;_&quot; + slice_numger + extension`` otherwise. E.g. ``prefix_x_000.png`` </span>
<span class="sd">           when ``X.ndim &lt; 4`` or ``prefix_x_000_000.png`` when ``X.ndim &gt;= 4``. </span>
<span class="sd">           The same applies to ``Y``.</span>
<span class="sd">    &quot;&quot;&quot;</span>   

    <span class="k">if</span> <span class="n">prefix</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="n">p_x</span> <span class="o">=</span> <span class="s2">&quot;x_&quot;</span>
        <span class="n">p_y</span> <span class="o">=</span> <span class="s2">&quot;y_&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">p_x</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;_x_&quot;</span>
        <span class="n">p_y</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;_y_&quot;</span>
 
    <span class="k">if</span> <span class="n">X</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">data_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>                                                    
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>       
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Not data_dir provided so no image will be saved!&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Saving images in </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data_dir</span><span class="p">))</span>

        <span class="n">v</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="mi">255</span> 
        <span class="k">if</span> <span class="n">X</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">im</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">((</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:,</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">))</span>
                        <span class="n">im</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">&#39;L&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">im</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">((</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:,</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span> <span class="s1">&#39;RGB&#39;</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="n">filenames</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">f</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">p_x</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> \
                                         <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">+</span> <span class="n">extension</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">f</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">filenames</span><span class="p">[(</span><span class="n">i</span><span class="o">*</span><span class="n">j</span><span class="p">)</span><span class="o">+</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">extension</span><span class="p">)</span>
                    <span class="n">im</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
                <span class="k">if</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">im</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">((</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">))</span>
                    <span class="n">im</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">&#39;L&#39;</span><span class="p">)</span>                                                
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">im</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">((</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span> <span class="s1">&#39;RGB&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">filenames</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">p_x</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">+</span> <span class="n">extension</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">filenames</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">extension</span><span class="p">)</span>
                <span class="n">im</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">Y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mask_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>                                                    
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">mask_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Not mask_dir provided so no image will be saved!&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Saving images in </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mask_dir</span><span class="p">))</span>

        <span class="n">v</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">scale_mask</span> <span class="k">else</span> <span class="mi">255</span>
        <span class="k">if</span> <span class="n">Y</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                        <span class="n">im</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">((</span><span class="n">Y</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">))</span>
                        <span class="n">im</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">&#39;L&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">filenames</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">c</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;_c&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                            <span class="n">f</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mask_dir</span><span class="p">,</span> <span class="n">p_y</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> \
                                             <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="n">d</span><span class="p">)</span><span class="o">+</span><span class="n">c</span><span class="o">+</span><span class="n">extension</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">f</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">filenames</span><span class="p">[(</span><span class="n">i</span><span class="o">*</span><span class="n">j</span><span class="p">)</span><span class="o">+</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">extension</span><span class="p">)</span>
    
                        <span class="n">im</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">im</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">((</span><span class="n">Y</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:,</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">))</span>         
                    <span class="n">im</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">&#39;L&#39;</span><span class="p">)</span>                                                
    
                    <span class="k">if</span> <span class="n">filenames</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">c</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;_c&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                        <span class="n">f</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mask_dir</span><span class="p">,</span> <span class="n">p_y</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="n">d</span><span class="p">)</span><span class="o">+</span><span class="n">c</span><span class="o">+</span><span class="n">extension</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">f</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mask_dir</span><span class="p">,</span> <span class="n">filenames</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">extension</span><span class="p">)</span>

                    <span class="n">im</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">f</span><span class="p">)</span></div>
       

<div class="viewcode-block" id="make_weight_map"><a class="viewcode-back" href="../util.html#util.make_weight_map">[docs]</a><span class="k">def</span> <span class="nf">make_weight_map</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">binary</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">w0</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="mi">5</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generates a weight map in order to make the U-Net learn better the          </span>
<span class="sd">       borders of cells and distinguish individual cells that are tightly packed.  </span>
<span class="sd">       These weight maps follow the methodology of the original U-Net paper.</span>

<span class="sd">       Based on `unet/py_files/helpers.py &lt;https://github.com/deepimagej/python4deepimagej/blob/499955a264e1b66c4ed2c014cb139289be0e98a4/unet/py_files/helpers.py&gt;`_.</span>
<span class="sd">   </span>
<span class="sd">       Parameters</span>
<span class="sd">       ----------</span>
<span class="sd">   </span>
<span class="sd">       label : 3D numpy array</span>
<span class="sd">          Corresponds to a label image. E.g. ``(x, y, channels)``.</span>
<span class="sd">   </span>
<span class="sd">       binary : bool, optional</span>
<span class="sd">          Corresponds to whether or not the labels are binary.                                                             </span>
<span class="sd">                                                                                   </span>
<span class="sd">       w0 : float, optional</span>
<span class="sd">          Controls for the importance of separating tightly associated entities.                                                </span>
<span class="sd">                                                                                   </span>
<span class="sd">       sigma : int, optional</span>
<span class="sd">          Represents the standard deviation of the Gaussian used for the weight map.</span>
<span class="sd">   </span>
<span class="sd">       Example</span>
<span class="sd">       -------</span>
<span class="sd">   </span>
<span class="sd">       Notice that weight has been defined where the objects are almost touching </span>
<span class="sd">       each other.</span>
<span class="sd">   </span>
<span class="sd">       .. image:: img/weight_map.png</span>
<span class="sd">           :width: 650</span>
<span class="sd">           :align: center</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># Initialization.</span>
    <span class="n">lab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
    <span class="n">lab_multi</span> <span class="o">=</span> <span class="n">lab</span>
       
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lab</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">lab</span> <span class="o">=</span> <span class="n">lab</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Get shape of label.</span>
    <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">lab</span><span class="o">.</span><span class="n">shape</span>
    
    <span class="k">if</span> <span class="n">binary</span><span class="p">:</span>
        
        <span class="c1"># Converts the label into a binary image with background = 0</span>
        <span class="c1"># and cells = 1.</span>
        <span class="n">lab</span><span class="p">[</span><span class="n">lab</span> <span class="o">==</span> <span class="mi">255</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        
        <span class="c1"># Builds w_c which is the class balancing map. In our case, we want </span>
        <span class="c1"># cells to have weight 2 as they are more important than background </span>
        <span class="c1"># which is assigned weight 1.</span>
        <span class="n">w_c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lab</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">w_c</span><span class="p">[</span><span class="n">w_c</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">w_c</span><span class="p">[</span><span class="n">w_c</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>
    
        <span class="c1"># Converts the labels to have one class per object (cell).</span>
        <span class="n">lab_multi</span> <span class="o">=</span> <span class="n">measure</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">lab</span><span class="p">,</span> <span class="n">neighbors</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="n">background</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        
        <span class="c1"># Converts the label into a binary image with background = 0.</span>
        <span class="c1"># and cells = 1.</span>
        <span class="n">lab</span><span class="p">[</span><span class="n">lab</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        
        <span class="c1"># Builds w_c which is the class balancing map. In our case, we want </span>
        <span class="c1"># cells to have weight 2 as they are more important than background </span>
        <span class="c1"># which is assigned weight 1.</span>
        <span class="n">w_c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lab</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">w_c</span><span class="p">[</span><span class="n">w_c</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">w_c</span><span class="p">[</span><span class="n">w_c</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">components</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">lab_multi</span><span class="p">)</span>
    
    <span class="n">n_comp</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">components</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
    
    <span class="n">maps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_comp</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">))</span>
    
    <span class="n">map_weight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">))</span>
    
    <span class="k">if</span> <span class="n">n_comp</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
            
            <span class="c1"># Only keeps current object.</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">lab_multi</span> <span class="o">==</span> <span class="n">components</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
            
            <span class="c1"># Invert tmp so that it can have the correct distance.</span>
            <span class="c1"># transform</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="o">~</span><span class="n">tmp</span>
            
            <span class="c1"># For each pixel, computes the distance transform to</span>
            <span class="c1"># each object.</span>
            <span class="n">maps</span><span class="p">[</span><span class="n">i</span><span class="p">][:][:]</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">ndimage</span><span class="o">.</span><span class="n">distance_transform_edt</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
    
        <span class="n">maps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">maps</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="c1"># Get distance to the closest object (d1) and the distance to the second</span>
        <span class="c1"># object (d2).</span>
        <span class="n">d1</span> <span class="o">=</span> <span class="n">maps</span><span class="p">[</span><span class="mi">0</span><span class="p">][:][:]</span>
        <span class="n">d2</span> <span class="o">=</span> <span class="n">maps</span><span class="p">[</span><span class="mi">1</span><span class="p">][:][:]</span>
        
        <span class="n">map_weight</span> <span class="o">=</span> <span class="n">w0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">((</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">lab</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">);</span>

    <span class="n">map_weight</span> <span class="o">+=</span> <span class="n">w_c</span>
    
    <span class="k">return</span> <span class="n">map_weight</span></div>


<div class="viewcode-block" id="do_save_wm"><a class="viewcode-back" href="../util.html#util.do_save_wm">[docs]</a><span class="k">def</span> <span class="nf">do_save_wm</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">binary</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">w0</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="mi">5</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Retrieves the label images, applies the weight-map algorithm and save the</span>
<span class="sd">       weight maps in a folder. Uses internally :meth:`util.make_weight_map`.</span>
<span class="sd">   </span>
<span class="sd">       Based on `deepimagejunet/py_files/helpers.py &lt;https://github.com/deepimagej/python4deepimagej/blob/499955a264e1b66c4ed2c014cb139289be0e98a4/unet/py_files/helpers.py&gt;`_.</span>
<span class="sd">   </span>
<span class="sd">       Parameters</span>
<span class="sd">       ----------</span>
<span class="sd">       labels : 4D numpy array</span>
<span class="sd">           Corresponds to given label images. E.g. ``(num_of_images, x, y, channels)``.</span>
<span class="sd">       </span>
<span class="sd">       path : str</span>
<span class="sd">           Refers to the path where the weight maps should be saved.</span>
<span class="sd">       </span>
<span class="sd">       binary : bool, optional</span>
<span class="sd">           Corresponds to whether or not the labels are binary. </span>
<span class="sd">       </span>
<span class="sd">       w0 : float, optional</span>
<span class="sd">           Controls for the importance of separating tightly associated entities. </span>
<span class="sd">           </span>
<span class="sd">       sigma : int, optional</span>
<span class="sd">           Represents the standard deviation of the Gaussian used for the weight </span>
<span class="sd">           map.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># Copy labels.</span>
    <span class="n">labels_</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
    
    <span class="c1"># Perform weight maps.</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels_</span><span class="p">)):</span>
        <span class="n">labels_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">make_weight_map</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">binary</span><span class="p">,</span> <span class="n">w0</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
    
    <span class="n">maps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">labels_</span><span class="p">)</span>
    
    <span class="n">n</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">maps</span><span class="o">.</span><span class="n">shape</span>
    
    <span class="c1"># Resize correctly the maps so that it can be used in the model.</span>
    <span class="n">maps</span> <span class="o">=</span> <span class="n">maps</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    
    <span class="c1"># Count number of digits in n. This is important for the number</span>
    <span class="c1"># of leading zeros in the name of the maps.</span>
    <span class="n">n_digits</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
    
    <span class="c1"># Save path with correct leading zeros.</span>
    <span class="n">path_to_save</span> <span class="o">=</span> <span class="n">path</span> <span class="o">+</span> <span class="s2">&quot;weight/{b:0&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">n_digits</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;d}.npy&quot;</span>
    
    <span class="c1"># Saving files as .npy files.</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels_</span><span class="p">)):</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">path_to_save</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">b</span><span class="o">=</span><span class="n">i</span><span class="p">),</span> <span class="n">labels_</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        
    <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="foreground_percentage"><a class="viewcode-back" href="../util.html#util.foreground_percentage">[docs]</a><span class="k">def</span> <span class="nf">foreground_percentage</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">class_tag</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Percentage of pixels that corresponds to the class in the given image.</span>

<span class="sd">       Parameters</span>
<span class="sd">       ----------</span>
<span class="sd">       mask : 2D Numpy array</span>
<span class="sd">           Image mask to analize.</span>

<span class="sd">       class_tag : int</span>
<span class="sd">           Class to find in the image.</span>

<span class="sd">       Returns</span>
<span class="sd">       -------</span>
<span class="sd">       x : float</span>
<span class="sd">           Percentage of pixels that corresponds to the class. Value between ``0`` </span>
<span class="sd">           and ``1``.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">class_tag</span><span class="p">:</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">c</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">c</span><span class="o">/</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span></div>


<div class="viewcode-block" id="divide_images_on_classes"><a class="viewcode-back" href="../util.html#util.divide_images_on_classes">[docs]</a><span class="k">def</span> <span class="nf">divide_images_on_classes</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">data_mask</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">th</span><span class="o">=</span><span class="mf">0.8</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a folder for each class where the images that have more pixels </span>
<span class="sd">       labeled as the class (in percentage) than the given threshold will be </span>
<span class="sd">       stored. </span>
<span class="sd">    </span>
<span class="sd">       Parameters</span>
<span class="sd">       ----------</span>
<span class="sd">       data : 4D numpy array</span>
<span class="sd">           Data to save as images. The first dimension must be the number of </span>
<span class="sd">           images. ``E.g. (num_of_images, x, y, channels)``.</span>

<span class="sd">       data_mask : 4D numpy array</span>
<span class="sd">           Data mask to save as images.  The first dimension must be the number </span>
<span class="sd">           of images. ``E.g. (num_of_images, x, y, channels)``.</span>

<span class="sd">       out_dir : str</span>
<span class="sd">           Path to save the images.</span>

<span class="sd">       num_classes : int, optional</span>
<span class="sd">           Number of classes. </span>

<span class="sd">       th : float, optional</span>
<span class="sd">           Percentage of the pixels that must be labeled as a class to save it</span>
<span class="sd">           inside that class folder. </span>
<span class="sd">    &quot;&quot;&quot;</span>
        
    <span class="c1"># Create the directories</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_classes</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;class&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;class&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Dividing provided data into </span><span class="si">{}</span><span class="s2"> classes . . .&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_classes</span><span class="p">))</span>
    <span class="n">d</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
        <span class="c1"># Assign the image to a class if it has, in percentage, more pixels of </span>
        <span class="c1"># that class than the given threshold </span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_classes</span><span class="p">):</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">foreground_percentage</span><span class="p">(</span><span class="n">data_mask</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">j</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="n">th</span><span class="p">:</span>
                <span class="n">im</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:,</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">im</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">&#39;L&#39;</span><span class="p">)</span>
                <span class="n">im</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;class&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)),</span> 
                        <span class="s2">&quot;im_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.png&quot;</span><span class="p">))</span>
                <span class="n">im</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">data_mask</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">255</span><span class="p">)</span>
                <span class="n">im</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">&#39;L&#39;</span><span class="p">)</span>
                <span class="n">im</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;class&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)),</span> 
                        <span class="s2">&quot;mask_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.png&quot;</span><span class="p">))</span></div>


<div class="viewcode-block" id="save_filters_of_convlayer"><a class="viewcode-back" href="../util.html#util.save_filters_of_convlayer">[docs]</a><span class="k">def</span> <span class="nf">save_filters_of_convlayer</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">,</span> <span class="n">l_num</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                              <span class="n">img_per_row</span><span class="o">=</span><span class="mi">8</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create an image of the filters learned by a convolutional layer. One can </span>
<span class="sd">       identify the layer with ``l_num`` or ``name`` args. If both are passed </span>
<span class="sd">       ``name`` will be prioritized. </span>
<span class="sd">    </span>
<span class="sd">       Inspired by https://machinelearningmastery.com/how-to-visualize-filters-and-feature-maps-in-convolutional-neural-networks</span>

<span class="sd">       Parameters</span>
<span class="sd">       ----------</span>
<span class="sd">       model : Keras Model</span>
<span class="sd">           Model where the layers are stored.</span>

<span class="sd">       out_dir : str</span>
<span class="sd">           Path where the image will be stored.</span>
<span class="sd">        </span>
<span class="sd">       l_num : int, optional</span>
<span class="sd">           Number of the layer to extract filters from. </span>
<span class="sd">            </span>
<span class="sd">       name : str, optional</span>
<span class="sd">           Name of the layer to extract filters from.</span>

<span class="sd">       prefix : str, optional</span>
<span class="sd">           Prefix to add to the output image name. </span>
<span class="sd">        </span>
<span class="sd">       img_per_row : int, optional</span>
<span class="sd">           Filters per row on the image.</span>

<span class="sd">       Raises   </span>
<span class="sd">       ------</span>
<span class="sd">       ValueError</span>
<span class="sd">           if ``l_num`` and ``name`` not provided.     </span>

<span class="sd">       Examples</span>
<span class="sd">       --------</span>
<span class="sd">       To save the filters learned by the layer called ``conv1`` one can call </span>
<span class="sd">       the function as follows ::</span>

<span class="sd">           save_filters_of_convlayer(model, char_dir, name=&quot;conv1&quot;, prefix=&quot;model&quot;)</span>

<span class="sd">       That will save in ``out_dir`` an image like this:</span>

<span class="sd">       .. image:: img/save_filters.png </span>
<span class="sd">           :width: 60%</span>
<span class="sd">           :align: center </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">l_num</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;One between &#39;l_num&#39; or &#39;name&#39; must be provided&quot;</span><span class="p">)</span>
    
    <span class="c1"># For matplotlib errors in display</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;QT_QPA_PLATFORM&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;offscreen&#39;</span>

    <span class="c1"># Find layer number of the layer named by &#39;name&#39; variable</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">pos</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">l_num</span> <span class="o">=</span> <span class="n">pos</span>

    <span class="n">filters</span><span class="p">,</span> <span class="n">biases</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">l_num</span><span class="p">]</span><span class="o">.</span><span class="n">get_weights</span><span class="p">()</span>
    
    <span class="c1"># normalize filter values to 0-1 so we can visualize them</span>
    <span class="n">f_min</span><span class="p">,</span> <span class="n">f_max</span> <span class="o">=</span> <span class="n">filters</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">filters</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">filters</span> <span class="o">=</span> <span class="p">(</span><span class="n">filters</span> <span class="o">-</span> <span class="n">f_min</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">f_max</span> <span class="o">-</span> <span class="n">f_min</span><span class="p">)</span>
    
    <span class="n">rows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">filters</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">/</span><span class="n">img_per_row</span><span class="p">))</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rows</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">img_per_row</span><span class="p">):</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">img_per_row</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">filters</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">]</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">filters</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>

            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">prefix</span> <span class="o">+=</span> <span class="s2">&quot;_&quot;</span> <span class="k">if</span> <span class="n">prefix</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span> <span class="k">else</span> <span class="n">prefix</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s1">&#39;f_layer&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">l_num</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span></div>


<div class="viewcode-block" id="calculate_2D_volume_prob_map"><a class="viewcode-back" href="../util.html#util.calculate_2D_volume_prob_map">[docs]</a><span class="k">def</span> <span class="nf">calculate_2D_volume_prob_map</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">w_foreground</span><span class="o">=</span><span class="mf">0.94</span><span class="p">,</span> <span class="n">w_background</span><span class="o">=</span><span class="mf">0.06</span><span class="p">,</span>
                                 <span class="n">save_file</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculate the probability map of the given 2D data.</span>

<span class="sd">       Parameters</span>
<span class="sd">       ----------</span>
<span class="sd">       Y : 4D Numpy array</span>
<span class="sd">           Data to calculate the probability map from. E. g. ``(num_of_images, x, </span>
<span class="sd">           y, channel)``</span>

<span class="sd">       w_foreground : float, optional</span>
<span class="sd">           Weight of the foreground. This value plus ``w_background`` must be </span>
<span class="sd">           equal ``1``.</span>

<span class="sd">       w_background : float, optional</span>
<span class="sd">           Weight of the background. This value plus ``w_foreground`` must be </span>
<span class="sd">           equal ``1``.</span>

<span class="sd">       save_file : str, optional</span>
<span class="sd">           Path to the file where the probability map will be stored.</span>

<span class="sd">       Raises</span>
<span class="sd">       ------</span>
<span class="sd">       ValueError</span>
<span class="sd">           if ``Y`` does not have 4 dimensions.                     </span>

<span class="sd">       ValueError</span>
<span class="sd">           if ``w_foreground + w_background &gt; 1``.</span>

<span class="sd">       Returns</span>
<span class="sd">       -------</span>
<span class="sd">       Array : 4D Numpy array</span>
<span class="sd">           Probability map of the given data.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">Y</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;Y&#39; must be a 4D Numpy array&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">w_foreground</span> <span class="o">+</span> <span class="n">w_background</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;w_foreground&#39; plus &#39;w_background&#39; can not be greater &quot;</span>
                         <span class="s2">&quot;than one&quot;</span><span class="p">)</span>

    <span class="n">prob_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Constructing the probability map . . .&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">prob_map</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
        <span class="n">pdf</span> <span class="o">=</span> <span class="n">prob_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    
        <span class="c1"># Remove artifacts connected to image border</span>
        <span class="n">pdf</span> <span class="o">=</span> <span class="n">clear_border</span><span class="p">(</span><span class="n">pdf</span><span class="p">)</span>

        <span class="n">foreground_pixels</span> <span class="o">=</span> <span class="p">(</span><span class="n">pdf</span> <span class="o">==</span> <span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">background_pixels</span> <span class="o">=</span> <span class="p">(</span><span class="n">pdf</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="n">pdf</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pdf</span> <span class="o">==</span> <span class="mi">255</span><span class="p">)]</span> <span class="o">=</span> <span class="n">w_foreground</span><span class="o">/</span><span class="n">foreground_pixels</span>
        <span class="n">pdf</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pdf</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="n">w_background</span><span class="o">/</span><span class="n">background_pixels</span>
        <span class="n">pdf</span> <span class="o">/=</span> <span class="n">pdf</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="c1"># Necessary to get all probs sum 1</span>
        <span class="n">prob_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pdf</span>

    <span class="k">if</span> <span class="n">save_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">save_file</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Saving the probability map in </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">save_file</span><span class="p">))</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">save_file</span><span class="p">,</span> <span class="n">prob_map</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">prob_map</span></div>


<div class="viewcode-block" id="calculate_3D_volume_prob_map"><a class="viewcode-back" href="../util.html#util.calculate_3D_volume_prob_map">[docs]</a><span class="k">def</span> <span class="nf">calculate_3D_volume_prob_map</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">w_foreground</span><span class="o">=</span><span class="mf">0.94</span><span class="p">,</span> <span class="n">w_background</span><span class="o">=</span><span class="mf">0.06</span><span class="p">,</span>
                                 <span class="n">save_file</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculate the probability map of the given 3D data.</span>
<span class="sd">       </span>
<span class="sd">       Parameters</span>
<span class="sd">       ---------- </span>
<span class="sd">       Y : 5D Numpy array</span>
<span class="sd">           Data to calculate the probability map from. E. g. ``(num_subvolumes,</span>
<span class="sd">           x, y, z, channel)``</span>

<span class="sd">       w_foreground : float, optional</span>
<span class="sd">           Weight of the foreground. This value plus ``w_background`` must be </span>
<span class="sd">           equal ``1``.</span>

<span class="sd">       w_background : float, optional</span>
<span class="sd">           Weight of the background. This value plus ``w_foreground`` must be </span>
<span class="sd">           equal ``1``.</span>

<span class="sd">       save_file : str, optional</span>
<span class="sd">           Path to the file where the probability map will be stored.</span>

<span class="sd">       Returns</span>
<span class="sd">       -------</span>
<span class="sd">       Array : 5D Numpy array</span>
<span class="sd">           Probability map of the given data.</span>

<span class="sd">       Raises</span>
<span class="sd">       ------</span>
<span class="sd">       ValueError</span>
<span class="sd">           if ``Y`` does not have 5 dimensions.</span>
<span class="sd">       ValueError</span>
<span class="sd">           if ``w_foreground + w_background &gt; 1``.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">Y</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">5</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;Y&#39; must be a 5D Numpy array&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">w_foreground</span> <span class="o">+</span> <span class="n">w_background</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;w_foreground&#39; plus &#39;w_background&#39; can not be greater &quot;</span>
                         <span class="s2">&quot;than one&quot;</span><span class="p">)</span>

    <span class="n">prob_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Constructing the probability map . . .&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">prob_map</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">prob_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])):</span>
            <span class="c1"># Remove artifacts connected to image border</span>
            <span class="n">prob_map</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">clear_border</span><span class="p">(</span><span class="n">prob_map</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:,</span><span class="n">j</span><span class="p">])</span>

        <span class="n">foreground_pixels</span> <span class="o">=</span> <span class="p">(</span><span class="n">prob_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">background_pixels</span> <span class="o">=</span> <span class="p">(</span><span class="n">prob_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="n">prob_map</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">prob_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">255</span><span class="p">)]</span> <span class="o">=</span> <span class="n">w_foreground</span><span class="o">/</span><span class="n">foreground_pixels</span>
        <span class="n">prob_map</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">prob_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="n">w_background</span><span class="o">/</span><span class="n">background_pixels</span>
        <span class="n">prob_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/=</span> <span class="n">prob_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="c1"># Necessary to get all probs sum 1</span>

    <span class="k">if</span> <span class="n">save_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">save_file</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Saving the probability map in </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">save_file</span><span class="p">))</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">save_file</span><span class="p">,</span> <span class="n">prob_map</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">prob_map</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="grayscale_2D_image_to_3D"><a class="viewcode-back" href="../util.html#util.grayscale_2D_image_to_3D">[docs]</a><span class="k">def</span> <span class="nf">grayscale_2D_image_to_3D</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">th</span><span class="o">=</span><span class="mi">127</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creates 3D surface from each image in X based on the grayscale of each</span>
<span class="sd">       image.</span>
<span class="sd">    </span>
<span class="sd">       Parameters</span>
<span class="sd">       ----------</span>
<span class="sd">       X : 4D numpy array</span>
<span class="sd">           Data that contains the images to create the surfaces from. E.g. </span>
<span class="sd">           ``(num_of_images, x, y, channels)``.</span>

<span class="sd">       Y : 4D numpy array</span>
<span class="sd">           Data mask of the same shape of X that will be converted into 3D volume,</span>
<span class="sd">           stacking multiple times each image. Useful if you need the two data</span>
<span class="sd">           arrays to be of the same shape. E.g. ``(num_of_images, x, y, channels)``.</span>

<span class="sd">       th : int, optional</span>
<span class="sd">           Values to ommit when creating the surfaces. Useful to reduce the</span>
<span class="sd">           amount of data in z to be created and reduce computational time.</span>

<span class="sd">       Returns</span>
<span class="sd">       -------</span>
<span class="sd">       Array : 5D numpy array</span>
<span class="sd">           3D surface of each image provided. E.g. ``(num_of_images, z, x, y, </span>
<span class="sd">           channels)``.</span>

<span class="sd">       Array : 5D numpy array</span>
<span class="sd">           3D stack of each mask provided. E.g. ``(num_of_images, z, x, y, </span>
<span class="sd">           channels)``.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Creating 3D surface for each image . . .&quot;</span><span class="p">)</span>

    <span class="n">_th</span> <span class="o">=</span> <span class="mi">255</span> <span class="o">-</span> <span class="n">th</span>
    <span class="n">X_3D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">_th</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> 
                    <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span> 
    <span class="n">Y_3D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">_th</span><span class="p">,</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
                    <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span> 
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="n">_th</span> <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span><span class="n">_th</span> <span class="k">else</span> <span class="mi">0</span>
                <span class="n">X_3D</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">pos</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">pos</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="mi">255</span>
                <span class="n">Y_3D</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">pos</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;*** New surface 3D data shape is now: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">X_3D</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">X_3D</span><span class="p">,</span> <span class="n">Y_3D</span></div>


<div class="viewcode-block" id="check_masks"><a class="viewcode-back" href="../util.html#util.check_masks">[docs]</a><span class="k">def</span> <span class="nf">check_masks</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">n_classes</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>                                                   
    <span class="sd">&quot;&quot;&quot;Check wheter the data masks have the correct labels inspection a few </span>
<span class="sd">       random images of the given path. If the function gives no error one </span>
<span class="sd">       should assume that the masks are correct.                                                       </span>
<span class="sd">                                                                                </span>
<span class="sd">       Parameters                                                               </span>
<span class="sd">       ----------                                                               </span>
<span class="sd">       path : str                                                               </span>
<span class="sd">           Path to the data mask.                                               </span>

<span class="sd">       n_classes : int, optional</span>
<span class="sd">           Maximum classes that the masks must contain. </span>
<span class="sd">    &quot;&quot;&quot;</span>                                                                         
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Checking wheter the images in </span><span class="si">{}</span><span class="s2"> are binary . . .&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>     
                                                                                
    <span class="n">ids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">path</span><span class="p">))[</span><span class="mi">2</span><span class="p">])</span>                                        
                                                                                
    <span class="c1"># Check only 4 random images or less if there are not as many               </span>
    <span class="n">num_sample</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">)]</span>                                                  
    <span class="n">numbers</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">)),</span> <span class="nb">min</span><span class="p">(</span><span class="n">num_sample</span><span class="p">))</span>                
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">numbers</span><span class="p">:</span>                                                           
        <span class="n">img</span> <span class="o">=</span> <span class="n">imread</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">ids</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>                                
        <span class="n">values</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>                          
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">n_classes</span> <span class="p">:</span>                                                    
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>                                                   
                <span class="s2">&quot;Error: given masks are not binary. Please correct the images &quot;</span> 
                <span class="s2">&quot;before training. (image: </span><span class="si">{}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">Values: </span><span class="si">{}</span><span class="s2">&quot;</span>             
                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">ids</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">values</span><span class="p">))</span>    </div>


<div class="viewcode-block" id="img_to_onehot_encoding"><a class="viewcode-back" href="../util.html#util.img_to_onehot_encoding">[docs]</a><span class="k">def</span> <span class="nf">img_to_onehot_encoding</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts image given into one-hot encode format.</span>

<span class="sd">       The opposite function is :func:`~onehot_encoding_to_img`.</span>

<span class="sd">       Parameters</span>
<span class="sd">       ----------</span>
<span class="sd">       img : Numpy 3D/4D array</span>
<span class="sd">           Image. E.g. ``(x, y, channels)`` or ``(x, y, z, channels)``.</span>

<span class="sd">       num_classes : int, optional</span>
<span class="sd">           Number of classes to distinguish.</span>

<span class="sd">       Returns</span>
<span class="sd">       -------</span>
<span class="sd">       one_hot_labels : Numpy 3D/4D array</span>
<span class="sd">           Data one-hot encoded. E.g. ``(x, y, num_classes)`` or </span>
<span class="sd">           ``(x, y, z, num_classes)``.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="n">num_classes</span><span class="p">,)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="n">num_classes</span><span class="p">,)</span>

    <span class="n">encoded_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_classes</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">encoded_image</span><span class="p">[:,:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="o">==</span> <span class="n">i</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">encoded_image</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="o">==</span> <span class="n">i</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">encoded_image</span></div>


<div class="viewcode-block" id="onehot_encoding_to_img"><a class="viewcode-back" href="../util.html#util.onehot_encoding_to_img">[docs]</a><span class="k">def</span> <span class="nf">onehot_encoding_to_img</span><span class="p">(</span><span class="n">encoded_image</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts one-hot encode image into an image with jus tone channel and all</span>
<span class="sd">       the classes represented by an integer. </span>

<span class="sd">       The opposite function is :func:`~img_to_onehot_encoding`.</span>

<span class="sd">       Parameters</span>
<span class="sd">       ----------</span>
<span class="sd">       encoded_image : Numpy 3D/4D array</span>
<span class="sd">           Image. E.g. ``(x, y, channels)`` or ``(x, y, z, channels)``.</span>

<span class="sd">       Returns</span>
<span class="sd">       -------</span>
<span class="sd">       img : Numpy 3D/4D array</span>
<span class="sd">           Data one-hot encoded. E.g. ``(x, y, z, num_classes)``.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">encoded_image</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">encoded_image</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="mi">1</span><span class="p">,)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">encoded_image</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="mi">1</span><span class="p">,)</span>

    <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">img</span><span class="p">[</span><span class="n">encoded_image</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> 

    <span class="k">return</span> <span class="n">img</span></div>


<div class="viewcode-block" id="load_data_from_dir2"><a class="viewcode-back" href="../util.html#util.load_data_from_dir2">[docs]</a><span class="k">def</span> <span class="nf">load_data_from_dir2</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">shape</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Load data with unknown shape from a directory.    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">data_2D_manipulation</span> <span class="kn">import</span> <span class="n">crop_data_with_overlap</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading data from </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data_dir</span><span class="p">))</span>

    <span class="n">ids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">data_dir</span><span class="p">))[</span><span class="mi">2</span><span class="p">])</span>

    <span class="n">hr_data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">id_</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">ids</span><span class="p">),</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">)):</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">imread</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">id_</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">img_cropped</span> <span class="o">=</span> <span class="n">crop_data_with_overlap</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">shape</span><span class="p">)</span>
        
        <span class="n">hr_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">img_cropped</span><span class="p">)</span>

    <span class="n">hr_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">hr_data</span><span class="p">)</span>
    <span class="n">hr_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">hr_data</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

    <span class="n">lr_data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">lr_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">hr_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
        <span class="n">lr_img</span> <span class="o">=</span> <span class="n">resize</span><span class="p">(</span><span class="n">hr_data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">lr_shape</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">preserve_range</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># bicubic </span>
        <span class="n">lr_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">lr_img</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">lr_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">lr_data</span><span class="p">)</span>
    <span class="n">lr_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">lr_data</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;*** HR created data shape is </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hr_data</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;*** LR created data shape is </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lr_data</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">hr_data</span><span class="p">,</span> <span class="n">lr_data</span></div>


<div class="viewcode-block" id="load_data_from_dir"><a class="viewcode-back" href="../util.html#util.load_data_from_dir">[docs]</a><span class="k">def</span> <span class="nf">load_data_from_dir</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">shape</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Load data from a directory.</span>

<span class="sd">       Parameters</span>
<span class="sd">       ----------</span>
<span class="sd">       data_dir : str </span>
<span class="sd">           Path to read the data from.</span>
<span class="sd">   </span>
<span class="sd">       shape : 3D int tuple</span>
<span class="sd">           Shape of the data. E.g. ``(x, y, channels)``.</span>
<span class="sd">       </span>
<span class="sd">       Returns</span>
<span class="sd">       -------        </span>
<span class="sd">       data : 4D Numpy array</span>
<span class="sd">           Data loaded. E.g. ``(num_of_images, y, x, channels)``.</span>

<span class="sd">       Examples</span>
<span class="sd">       --------</span>
<span class="sd">       ::</span>
<span class="sd">           # EXAMPLE 1</span>
<span class="sd">           # Case where we need to load 165 images of shape (1024, 768)</span>
<span class="sd">           data_path = &quot;data/train/x&quot;</span>
<span class="sd">           data_shape = (1024, 768, 1)</span>
<span class="sd">           </span>
<span class="sd">           load_data_from_dir(data_path, data_shape) </span>
<span class="sd">           # The function will print the shape of the created array. In this example:</span>
<span class="sd">           #     *** Loaded data shape is (165, 768, 1024, 1)</span>
<span class="sd">           # Notice height and width swap because of Numpy ndarray terminology</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading data from </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data_dir</span><span class="p">))</span>
    <span class="n">ids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">data_dir</span><span class="p">))[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">),</span> <span class="p">)</span> <span class="o">+</span> <span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">id_</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">ids</span><span class="p">),</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">)):</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">imread</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">id_</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">data</span><span class="p">[</span><span class="n">n</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">0</span><span class="p">:</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">0</span><span class="p">:</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">img</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;*** Loaded data shape is </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="load_ct_data_from_dir"><a class="viewcode-back" href="../util.html#util.load_ct_data_from_dir">[docs]</a><span class="k">def</span> <span class="nf">load_ct_data_from_dir</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Load CT data from a directory.</span>

<span class="sd">       Parameters</span>
<span class="sd">       ----------</span>
<span class="sd">       data_dir : str</span>
<span class="sd">           Path to read the data from.</span>

<span class="sd">       shape : optional, 3D int tuple</span>
<span class="sd">           Shape of the data. E.g. ``(x, y, channels)``.</span>

<span class="sd">       Returns</span>
<span class="sd">       -------</span>
<span class="sd">       data : 4D Numpy array</span>
<span class="sd">           Data loaded. E.g. ``(num_of_images, y, x, channels)``.</span>

<span class="sd">       Examples</span>
<span class="sd">       --------</span>
<span class="sd">       ::</span>

<span class="sd">           # EXAMPLE 1</span>
<span class="sd">           # Case where we need to load 165 images of shape (1024, 768)</span>
<span class="sd">           data_path = &quot;data/train/x&quot;</span>
<span class="sd">           data_shape = (1024, 768, 1)</span>

<span class="sd">           load_data_from_dir(data_path, data_shape)</span>

<span class="sd">           # The function will print the shape of the created array. In this example:</span>
<span class="sd">           #     *** Loaded data shape is (165, 768, 1024, 1)</span>
<span class="sd">           # Notice height and width swap because of Numpy ndarray terminology</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">nibabel</span> <span class="k">as</span> <span class="nn">nib</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading data from </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data_dir</span><span class="p">))</span>
    <span class="n">ids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">data_dir</span><span class="p">))[</span><span class="mi">2</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">shape</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Determine max in each dimension first</span>
        <span class="n">max_x</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">max_y</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">max_z</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">id_</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">ids</span><span class="p">),</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">)):</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">id_</span><span class="p">))</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">dataobj</span><span class="p">)</span>

            <span class="n">max_x</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">max_x</span> <span class="o">&lt;</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">else</span> <span class="n">max_x</span>
            <span class="n">max_y</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">max_y</span> <span class="o">&lt;</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">else</span> <span class="n">max_y</span>
            <span class="n">max_z</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="n">max_z</span> <span class="o">&lt;</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">else</span> <span class="n">max_z</span>
        <span class="n">_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_x</span><span class="p">,</span> <span class="n">max_y</span><span class="p">,</span> <span class="n">max_z</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">_shape</span> <span class="o">=</span> <span class="n">shape</span>

    <span class="c1"># Create the array</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">),</span> <span class="p">)</span> <span class="o">+</span> <span class="n">_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">id_</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">ids</span><span class="p">),</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">)):</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">id_</span><span class="p">))</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">dataobj</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="n">n</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">0</span><span class="p">:</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">0</span><span class="p">:</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">img</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;*** Loaded data shape is </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="load_3d_images_from_dir"><a class="viewcode-back" href="../util.html#util.load_3d_images_from_dir">[docs]</a><span class="k">def</span> <span class="nf">load_3d_images_from_dir</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">crop</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">subvol_shape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">overlap</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">median_padding</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">return_filenames</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Load data from a directory.</span>

<span class="sd">       Parameters</span>
<span class="sd">       ----------</span>
<span class="sd">       data_dir : str</span>
<span class="sd">           Path to read the data from.</span>

<span class="sd">       shape : 4D int tuple</span>
<span class="sd">           Shape of the images to load. E.g. ``(x, y, z, channels)``.</span>

<span class="sd">       crop : bool, optional</span>
<span class="sd">           Crop each 3D image when readed.</span>

<span class="sd">       subvol_shape : Tuple of 4 ints, optional</span>
<span class="sd">           Shape of the subvolumes to create when cropping. </span>
<span class="sd">           E.g. ``(x, y, z, channels)``.</span>

<span class="sd">       overlap : Tuple of 3 floats, optional</span>
<span class="sd">           Amount of minimum overlap on x, y and z dimensions. The values must</span>
<span class="sd">           be on range ``[0, 1)``, that is, ``0%`` or ``99%`` of overlap.  </span>
<span class="sd">           E. g. ``(x, y, z)``.</span>
<span class="sd">           </span>
<span class="sd">       padding : 4D Numpy array, optional</span>
<span class="sd">            Size of padding to be added on each side</span>

<span class="sd">       median_padding: bool</span>
<span class="sd">           If True the padding value is the median value. If False, the added values are zeroes.   </span>
<span class="sd">  </span>
<span class="sd">       return_filenames : bool, optional</span>
<span class="sd">           Return a list with the loaded filenames. Useful when you need to save</span>
<span class="sd">           them afterwards with the same names as the original ones.</span>
<span class="sd">        </span>
<span class="sd">       Returns</span>
<span class="sd">       -------</span>
<span class="sd">       data : 5D Numpy array</span>
<span class="sd">           Data loaded. E.g. ``(num_of_images, x, y, z, channels)`` if ``crop``</span>
<span class="sd">           enabled, ``(num_of_images, z, y, x, channels)`` otherwise.</span>

<span class="sd">       data_shape : List of tuples, optional </span>
<span class="sd">           Shapes of all 3D images readed. Useful to reconstruct the original </span>
<span class="sd">           images together with ``crop_shape``. </span>

<span class="sd">       crop_shape : List of tuples, optional</span>
<span class="sd">           Shape of the loaded 3D images after cropping. Useful to reconstruct </span>
<span class="sd">           the original images together with ``data_shape``.</span>
<span class="sd">    </span>
<span class="sd">       filenames : List of str, optional</span>
<span class="sd">           Loaded filenames.</span>

<span class="sd">       Examples</span>
<span class="sd">       --------</span>
<span class="sd">       ::</span>
<span class="sd">           # EXAMPLE 1</span>
<span class="sd">           # Case where we need to load 20 images of shape (1024, 1024, 91, 1)</span>
<span class="sd">           data_path = &quot;data/train/x&quot;</span>
<span class="sd">           data_shape = (1024, 1024, 91, 1)</span>

<span class="sd">           data = load_data_from_dir(data_path, data_shape)</span>
<span class="sd">           # The function will print the shape of the created array. In this example:</span>
<span class="sd">           #     *** Loaded data shape is (20, 91, 1024, 1024, 1)</span>
<span class="sd">           # Notice height, width and depth swap as skimage.io imread function </span>
<span class="sd">           # is used to load images </span>
<span class="sd">    </span>
<span class="sd">           # EXAMPLE 2</span>
<span class="sd">           # Same as example 1 but with unknown shape, cropping them into (256, 256, 40, 1) subvolumes</span>
<span class="sd">           # with minimum overlap and storing filenames.</span>
<span class="sd">           data_path = &quot;data/train/x&quot;</span>

<span class="sd">           X_test, orig_test_img_shapes, \</span>
<span class="sd">           crop_test_img_shapes, te_filenames = load_3d_images_from_dir(</span>
<span class="sd">               test_path, None, crop=True, subvol_shape=(256, 256, 40, 1),</span>
<span class="sd">               overlap=(0,0,0), return_filenames=True)</span>
<span class="sd">           # The function will print the shape of the created array which its size is </span>
<span class="sd">           # the concatenation in 0 axis of all subvolumes created for each 3D image in the</span>
<span class="sd">           # given path. For example:</span>
<span class="sd">           #     *** Loaded data shape is (350, 256, 256, 40, 1)</span>
<span class="sd">           # Notice height, width and depth swap as skimage.io imread function</span>
<span class="sd">           # is used to load images.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">shape</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;shape&#39; must be 4 length tuple&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">crop</span> <span class="ow">and</span> <span class="n">subvol_shape</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;subvol_shape&#39; must be provided when &#39;crop&#39; is True&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">return_filenames</span><span class="p">:</span>
        <span class="n">filenames</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading data from </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data_dir</span><span class="p">))</span>
    <span class="n">ids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">data_dir</span><span class="p">))[</span><span class="mi">2</span><span class="p">])</span>

    <span class="c1"># Determine shape if it is not given </span>
    <span class="k">if</span> <span class="n">shape</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">crop</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Determine max in each dimension first&quot;</span><span class="p">)</span>
        <span class="n">max_x</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">max_y</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">max_z</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">id_</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">ids</span><span class="p">),</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">)):</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">imread</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">id_</span><span class="p">))</span>

            <span class="n">max_x</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">max_x</span> <span class="o">&lt;</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">else</span> <span class="n">max_x</span>
            <span class="n">max_y</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="n">max_y</span> <span class="o">&lt;</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">else</span> <span class="n">max_y</span>
            <span class="n">max_z</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">max_z</span> <span class="o">&lt;</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">else</span> <span class="n">max_z</span>
        <span class="n">c</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span> <span class="k">else</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> 
        <span class="n">_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_z</span><span class="p">,</span> <span class="n">max_y</span><span class="p">,</span> <span class="n">max_x</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">crop</span><span class="p">:</span>
            <span class="n">_shape</span> <span class="o">=</span> <span class="n">subvol_shape</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">crop</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">data_3D_manipulation</span> <span class="kn">import</span> <span class="n">crop_3D_data_with_overlap</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">data_shape</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">crop_shape</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">),</span> <span class="p">)</span> <span class="o">+</span> <span class="n">_shape</span><span class="p">)</span>

    <span class="c1"># Read images </span>
    <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">id_</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">ids</span><span class="p">),</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">)):</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">imread</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">id_</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">return_filenames</span><span class="p">:</span>
            <span class="n">filenames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">id_</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>                                                 
            <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>                                  
            
        <span class="k">if</span> <span class="n">crop</span><span class="p">:</span>
            <span class="n">data_shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">subvol_shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],):</span>
                <span class="n">img_cropped</span> <span class="o">=</span> <span class="n">crop_3D_data_with_overlap</span><span class="p">(</span>
                    <span class="n">img</span><span class="p">,</span> <span class="n">subvol_shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],),</span> <span class="n">overlap</span><span class="o">=</span><span class="n">overlap</span><span class="p">,</span>
                    <span class="n">padding</span><span class="o">=</span><span class="n">padding</span><span class="p">,</span> <span class="n">median_padding</span><span class="o">=</span><span class="n">median_padding</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">img_cropped</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">crop_shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">img_cropped</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">img_cropped</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
            <span class="n">data</span><span class="p">[</span><span class="n">n</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">0</span><span class="p">:</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">0</span><span class="p">:</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">img</span>

    <span class="k">if</span> <span class="n">crop</span><span class="p">:</span> <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;*** Loaded data shape is </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">crop</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">return_filenames</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">data_shape</span><span class="p">,</span> <span class="n">crop_shape</span><span class="p">,</span> <span class="n">filenames</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">data_shape</span><span class="p">,</span> <span class="n">crop_shape</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">return_filenames</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">filenames</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2021, Daniel Franco

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>