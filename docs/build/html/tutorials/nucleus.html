

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>3D Nuclei Instance Segmentation &mdash; EM Image Segmentation  documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Stable DNN architectures for mitochondria segmentation" href="../manuscripts/stable_mitochondria.html" />
    <link rel="prev" title="2D Mitochondria segmentation" href="mitochondria.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> EM Image Segmentation
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">How to run</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../how_to_run/bash.html">Bash shell</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how_to_run/colab.html">Colab</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how_to_run/docker.html">Docker container</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how_to_run/singularity.html">Singularity container</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="mitochondria.html">2D Mitochondria segmentation</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">3D Nuclei Instance Segmentation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#problem-description">Problem description</a></li>
<li class="toctree-l2"><a class="reference internal" href="#data-preparation">Data preparation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#problem-resolution">Problem resolution</a></li>
<li class="toctree-l2"><a class="reference internal" href="#configuration-file">Configuration file</a></li>
<li class="toctree-l2"><a class="reference internal" href="#run">Run</a></li>
<li class="toctree-l2"><a class="reference internal" href="#results">Results</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Manuscripts</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../manuscripts/stable_mitochondria.html">Stable DNN architectures for mitochondria segmentation</a></li>
</ul>
<p class="caption"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../config/main_config.html">config</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data/data.html">data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../engine/engine.html">engine</a></li>
<li class="toctree-l1"><a class="reference internal" href="../models/models.html">models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sota_implementations/sota_implementations.html">sota_implementations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../utils/utils.html">utils</a></li>
</ul>
<p class="caption"><span class="caption-text">Bibliography</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../bibliography.html">Bibliography</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">EM Image Segmentation</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>3D Nuclei Instance Segmentation</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="d-nuclei-instance-segmentation">
<span id="nucleus-tutorial"></span><h1>3D Nuclei Instance Segmentation<a class="headerlink" href="#d-nuclei-instance-segmentation" title="Permalink to this headline">¶</a></h1>
<div class="section" id="problem-description">
<h2>Problem description<a class="headerlink" href="#problem-description" title="Permalink to this headline">¶</a></h2>
<p>The goal is to segment and identify automatically each cell nuclei in EM images.
This is an instance segmentation problem, which is the next step of semantic
segmentation, as its requires identifying each blob unequivocally with a given
id. In this tutorial, pairs of EM 3D images (<img class="math" src="../_images/math/ed38fa24f1c94891bd312012aab3f6673be3eb83.svg" alt="X"/>) with their corresponding instance
sementation annotations (<img class="math" src="../_images/math/7daf0d4815e763eb90f0d5f1dc406f668c1e21db.svg" alt="Y"/>) are provided. Here NucMM-Z dataset <span id="id1">[<a class="reference internal" href="../bibliography.html#id2" title="Zudi Lin, Donglai Wei, Mariela D. Petkova, Yuelong Wu, Zergham Ahmed, Krishna Swaroop K, Silin Zou, Nils Wendt, Jonathan Boulanger-Weill, Xueying Wang, Nagaraju Dhanyasi, Ignacio Arganda-Carreras, Florian Engert, Jeff Lichtman, and Hanspeter Pfister. Nucmm dataset: 3d neuronal nuclei instance segmentation at sub-cubic millimeter scale. 2021. arXiv:2107.05840.">LWP+21</a>]</span>
is used:</p>
<div class="figure align-center" id="id4">
<a class="reference internal image-reference" href="../_images/nucmm_z_paper_view.png"><img alt="Nucmm-z dataset overview" src="../_images/nucmm_z_paper_view.png" style="width: 576.0px; height: 178.5px;" /></a>
<p class="caption"><span class="caption-text">Overview of the NucMM-Z dataset volume. Electron microscopy (EM) volume
covering nearly a whole zebrafish brain. Modified image from <span id="id2">[<a class="reference internal" href="../bibliography.html#id2" title="Zudi Lin, Donglai Wei, Mariela D. Petkova, Yuelong Wu, Zergham Ahmed, Krishna Swaroop K, Silin Zou, Nils Wendt, Jonathan Boulanger-Weill, Xueying Wang, Nagaraju Dhanyasi, Ignacio Arganda-Carreras, Florian Engert, Jeff Lichtman, and Hanspeter Pfister. Nucmm dataset: 3d neuronal nuclei instance segmentation at sub-cubic millimeter scale. 2021. arXiv:2107.05840.">LWP+21</a>]</span>.</span><a class="headerlink" href="#id4" title="Permalink to this image">¶</a></p>
</div>
<p>In this dataset 27 3D images of <code class="docutils literal notranslate"><span class="pre">(64,</span> <span class="pre">64,</span> <span class="pre">64)</span></code> are used for train while the test is
done over the whole Zebrafish volume. Here is a training sample and its ground
truth:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><div class="figure align-center" id="id5">
<img alt="../_images/nucmm_z_volume.gif" src="../_images/nucmm_z_volume.gif" />
<p class="caption"><span class="caption-text">EM tissue volume (<img class="math" src="../_images/math/ed38fa24f1c94891bd312012aab3f6673be3eb83.svg" alt="X"/>).</span><a class="headerlink" href="#id5" title="Permalink to this image">¶</a></p>
</div>
</td>
<td><div class="figure align-center" id="id6">
<img alt="../_images/nucmm_z_volume_mask.gif" src="../_images/nucmm_z_volume_mask.gif" />
<p class="caption"><span class="caption-text">Corresponding instance labels (<img class="math" src="../_images/math/7daf0d4815e763eb90f0d5f1dc406f668c1e21db.svg" alt="Y"/>).</span><a class="headerlink" href="#id6" title="Permalink to this image">¶</a></p>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="data-preparation">
<h2>Data preparation<a class="headerlink" href="#data-preparation" title="Permalink to this headline">¶</a></h2>
<p>The data directory tree should follow the structure described <a class="reference external" href="../how_to_run/bash.html#step-1-data-preparation">Bash Shell -&gt; Step 1: Data preparation</a>.</p>
</div>
<div class="section" id="problem-resolution">
<h2>Problem resolution<a class="headerlink" href="#problem-resolution" title="Permalink to this headline">¶</a></h2>
<p>To produce the nuclei instances two main steps are done:</p>
<ul class="simple">
<li><p>Firstly, new <img class="math" src="../_images/math/e17cbfdc13f71a51b1bcc3eaf01617769969441c.svg" alt="\hat{Y}"/> data representations are created from the original <img class="math" src="../_images/math/7daf0d4815e763eb90f0d5f1dc406f668c1e21db.svg" alt="Y"/>. This new <img class="math" src="../_images/math/e17cbfdc13f71a51b1bcc3eaf01617769969441c.svg" alt="\hat{Y}"/> data is created with up to three channels (controlled by <code class="docutils literal notranslate"><span class="pre">DATA.CHANNELS</span></code>). Binary segmentation (referred as <code class="docutils literal notranslate"><span class="pre">B</span></code> in the code), contour (<code class="docutils literal notranslate"><span class="pre">C</span></code>) and distances (<code class="docutils literal notranslate"><span class="pre">D</span></code>). This way, the network will be trained with 27 image pairs provided in NucMM-Z, each containing an EM image and its <img class="math" src="../_images/math/e17cbfdc13f71a51b1bcc3eaf01617769969441c.svg" alt="\hat{Y}"/> new data representation.</p></li>
<li><p>These extra channels predicted by the network are used to create the final instance segmentation labels using a marked controlled watershed (MW). This process involve a few thresholds that may be adjusted depending each case: <code class="docutils literal notranslate"><span class="pre">DATA.MW_TH1</span></code>, <code class="docutils literal notranslate"><span class="pre">DATA.MW_TH2</span></code>, <code class="docutils literal notranslate"><span class="pre">DATA.MW_TH3</span></code>, <code class="docutils literal notranslate"><span class="pre">DATA.MW_TH4</span></code> and <code class="docutils literal notranslate"><span class="pre">DATA.MW_TH5</span></code>. Find their description in <a class="reference external" href="https://github.com/danifranco/EM_Image_Segmentation/blob/master/config/config.py">config.py</a>.</p></li>
</ul>
</div>
<div class="section" id="configuration-file">
<h2>Configuration file<a class="headerlink" href="#configuration-file" title="Permalink to this headline">¶</a></h2>
<p>To create the YAML file you can use the template <a class="reference external" href="https://github.com/danifranco/EM_Image_Segmentation/blob/master/templates/resunet_3d_instances.yaml">resunet_3d_instances.yaml</a> which is prepared for this tutorial.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p>Adapt the configuration file to your specific case and see more configurable options available at <a class="reference external" href="https://github.com/danifranco/EM_Image_Segmentation/blob/master/config/config.py">config.py</a>.</p>
</div>
</div>
<div class="section" id="run">
<h2>Run<a class="headerlink" href="#run" title="Permalink to this headline">¶</a></h2>
<p>Run the code with any of the options described in <strong>HOW TO RUN</strong> section that best suits you. For instance, you can run
it through bash shell as described in: <a class="reference external" href="../how_to_run/bash.html#step-3-run-the-code">Bash Shell -&gt; Step 3: Run the code</a>.</p>
</div>
<div class="section" id="results">
<h2>Results<a class="headerlink" href="#results" title="Permalink to this headline">¶</a></h2>
<p>The resulting instance segmentation should be something like this:</p>
<div class="figure align-center" id="id7">
<a class="reference internal image-reference" href="../_images/nucmm_z_instances_medium.gif"><img alt="Nucmm-z dataset overview" src="../_images/nucmm_z_instances_medium.gif" style="width: 768.0px; height: 275.2px;" /></a>
<p class="caption"><span class="caption-text">Instance segmentation results on the whole dataset.</span><a class="headerlink" href="#id7" title="Permalink to this image">¶</a></p>
</div>
<div class="figure align-center" id="id8">
<a class="reference internal image-reference" href="../_images/smallpart_nucmm_z_instances.gif"><img alt="Nucmm-z dataset overview (zoomed version)" src="../_images/smallpart_nucmm_z_instances.gif" style="width: 228.8px; height: 345.6px;" /></a>
<p class="caption"><span class="caption-text">Zoom of a small region of the instance prediction.</span><a class="headerlink" href="#id8" title="Permalink to this image">¶</a></p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../manuscripts/stable_mitochondria.html" class="btn btn-neutral float-right" title="Stable DNN architectures for mitochondria segmentation" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="mitochondria.html" class="btn btn-neutral float-left" title="2D Mitochondria segmentation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2021, Daniel Franco

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>